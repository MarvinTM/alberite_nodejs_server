<html>
<head>
</head>
<body>
<script>

function doRemoteRequest(endPoint, callback) {
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
      if (xmlhttp.status == 200) {
        callback(JSON.parse(xmlhttp.responseText));
      } else if (xmlhttp.status == 400) {
        console.error('There was an error 400');
      } else {
        console.error('something else other than 200 was returned');
      }
    }
  };

  xmlhttp.open("GET", endPoint, true);
  xmlhttp.send();
};

setInterval(function() {
  doRemoteRequest('loginfo', function(logInfo) {
    if(logInfo.length===0) {
      document.getElementById("logContainer").innerHTML = 'Nada'; 
      return;
    }
    var logTable = "<table style='width:100%'><tr'><th style='width:40%'>MENSAJE</th><th style='width:50%'>FECHA</th><th>IP</th></tr>";
    logInfo.forEach(function(logrow) {
      var bgColor;
      if(logrow.type==='INFO'){
        bgColor = '#00ff00';
      } else if (logrow.type==='ACTION') {
        bgColor = '#00ffff';
      } else {
        bgColor = '#ff0000';
      }
      logTable+="<tr style='background-color:"+bgColor+";'><td>"+logrow.message+"</td><td>"+new Date(logrow.messagedate).toLocaleString()+"</td><td>"+logrow.externalip+"</td>";
    });        
    document.getElementById("logContainer").innerHTML = logTable; 
  });

  doRemoteRequest('actionsInfo', function(actionsInfo) {
    if(actionsInfo.length===0) {
      document.getElementById("actionsContainer").innerHTML = '<b>Nada</b>'; 
      return;
    }
    var logTable = "<table style='width:100%'><tr'><th style='width:40%'>FASE</th><th style='width:50%'>DURACIÓN (segundos)</th></tr>";
    actionsInfo.forEach(function(logrow) {
      var bgColor;
      if(logrow.programmed_action!==null) {
        bgColor = '#ffff00';
      } else {
        bgColor = '#00ffff';
      }
      logTable+="<tr style='background-color:"+bgColor+";'><td>"+logrow.phase+"</td><td>"+logrow.time+"</td>";
    });        
    document.getElementById("actionsContainer").innerHTML = logTable; 

  });

  doRemoteRequest('programmedActionsInfo', function(actionsInfo) {
    if(actionsInfo.length===0) {
      document.getElementById("programmedActionsContainer").innerHTML = '<b>Nada</b>'; 
      return;
    }
    var logTable = "<table style='width:100%'><tr'><th style='width:10%'>FASE</th><th style='width:10%'>DURACIÓN (segundos)</th><th style='width:50%'>FRECUENCIA</th><th style='width:10%'>HORA</th></tr>";
    actionsInfo.forEach(function(logrow) {
      var bgColor;
      bgColor = '#ffff00';
      logTable+="<tr style='background-color:"+bgColor+";'><td>"+logrow.phase+"</td><td>"+logrow.time+"</td>";
      logTable+="<td>"+logrow.frequency+"</td><td>"+logrow.hour+"</td>";
    });        
    document.getElementById("programmedActionsContainer").innerHTML = logTable; 

  });

}, 1000);

function element(id) {
  return document.getElementById(id);
};

function doRequestForSystemAction(actionId) {
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
      if (xmlhttp.status == 200) {
        alert('Éxito');
      } else if (xmlhttp.status == 400) {
        alert('Error al iniciar acción: '+400);
      } else {
        alert('Error al iniciar acción: '+xmlhttp.status);
      }
    }
  };

  xmlhttp.open("GET", "/startSystemAction?pin="+actionId+"&duration=10&", true);
  xmlhttp.send();
}

function doRegisterUser() {
  document.location = "/registerUser";
};


function doLogout() {
  document.location = "/logout";
};

function navigateProgram() {
  document.location = "/program";
};


</script>
<div id="mainContainer">
  <div id="leftContainer" style="width:48%;float:left;padding:5px">
    <div style="border-width: 1px;border-style: solid;margin-top:10px; padding:10px">
      <div>RIEGOS ACTUALES EN COLA</div>
      <div id="actionsContainer"></div>
    </div>
    <div style="border-width: 1px;border-style: solid;margin-top:10px; padding:10px">
      <div>RIEGOS PROGRAMADOS</div>
      <div id="programmedActionsContainer"></div>
    </div>
    <div style="border-width: 1px;border-style: solid;margin-top:10px; padding:10px">
      <div>RIEGO</div>
      <div id="riegoContainer">
        <div id="poolPhase1">Regar Piscina fase 1</div>
        <div id="poolPhase2">Regar Piscina fase 2</div>
        <div id="mainPhase1">Regar Aspersores fase 1</div>
        <div id="backyard">Regar Zona cerezo</div>
        <div id="orchard">Regar Huerta</div>
      </div>
    </div>
    <div style="border-width: 1px;border-style: solid;margin-top:10px; padding:10px">
      <div>OPCIONES</div>
      <div id="optionsContainer">
        <div id="program">Programar riego</div>
        <div id="logout">Salir</div>
      </div>
    </div>
  </div>
  <div id="rightContainer" style="width:48%;float:left;padding:5px;">
    <div style="border-width: 1px;border-style: solid;padding:10px">
      <div>LOG</div>
      <div id="logContainer">el log</div>
    </div>
  </div>
</div>

<script>
element('poolPhase1').style.cursor = 'pointer';
element('poolPhase2').style.cursor = 'pointer';
element('mainPhase1').style.cursor = 'pointer';
element('backyard').style.cursor = 'pointer';
element('orchard').style.cursor = 'pointer';
element('logout').style.cursor = 'pointer';
element('program').style.cursor = 'pointer';
element('poolPhase1').style.color = 'blue';
element('poolPhase2').style.color = 'blue';
element('mainPhase1').style.color = 'blue';
element('backyard').style.color = 'blue';
element('orchard').style.color = 'blue';
element('logout').style.color = 'blue';
element('program').style.color = 'blue';


element('poolPhase1').onclick = function() {
  doRequestForSystemAction(1);
};

element('poolPhase2').onclick = function() {
  doRequestForSystemAction(2);
};

element('mainPhase1').onclick = function() {
  doRequestForSystemAction(3);
};

element('backyard').onclick = function() {
  doRequestForSystemAction(4);
};

element('orchard').onclick = function() {
  doRequestForSystemAction(5);
};

element('logout').onclick = function() {
  doLogout();
};

element('program').onclick = function() {
  navigateProgram();
};

</script>
</body>
</html>
